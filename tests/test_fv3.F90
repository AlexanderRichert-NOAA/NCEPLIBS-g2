! This is a test program for NCEPLIBS-g2.
!
! This program tests reading a very large FV3 GRIB2 file, only
! downloaded if both the FTP_TEST_FILES and the FTP_LARGE_TEST_FILES
! are set to ON at build time.
!
! Ed Hartnett 7/17/23
program test_fv3
  use grib_mod
  implicit none
  
  ! THese are the test files we will use.
  character(*) :: TEST_FILE
  parameter (TEST_FILE = 'data/fv3lam.t00z.prslev.f000.grib2')
  integer :: NUM_MSG
  parameter (NUM_MSG = 555)
  integer :: lugb = 10
  integer :: jdisc = -1, jpdtn = -1, jgdtn = -1, jskp = 0
  integer, dimension(200) :: jids, jpdt, jgdt
  logical :: unpack = .true.
  type(gribfield) :: gfld
  integer :: i
  integer*8 :: lskip8, lgrib8, start8
  integer :: iret
  integer*8 :: expected_lskip8(NUM_MSG) = (/0_8, 13342681_8, 24228864_8, 26958473_8, 28943885_8, 33491509_8, &
       35662921_8, 37513651_8, 41466849_8, 49796382_8, &
       52338669_8, 54145441_8, 59420674_8, 70005385_8, 80346316_8, 94134044_8, &
       109418487_8, 124174637_8, 135296376_8, 146267769_8, &
       160530839_8, 163669983_8, 165476755_8, 176358032_8, 178967180_8, 180956974_8, &
       185509096_8, 187687857_8, 189539360_8, 193442018_8, &
       201755899_8, 204248168_8, 206054940_8, 211395997_8, 221765391_8, 231845074_8, &
       247029419_8, 258193997_8, 269162211_8, 270968983_8, &
       281705758_8, 282502959_8, 284309731_8, 286116503_8, 291699618_8, 300208170_8, &
       304072773_8, 304072964_8, 323776602_8, 332190201_8, &
       340619636_8, 347064318_8, 355139879_8, 356946651_8, 360886552_8, 370720872_8, &
       375977362_8, 378424610_8, 380231410_8, 388331078_8, &
       400797779_8, 406269857_8, 412685033_8, 418813138_8, 420619910_8, 422426710_8, &
       424233510_8, 426040310_8, 427847110_8, 429653910_8, &
       431460682_8, 441754179_8, 447002535_8, 451243787_8, 453050587_8, 461065023_8, &
       475743186_8, 481235700_8, 488100961_8, 494533623_8, &
       496340395_8, 498147195_8, 499953995_8, 501760795_8, 503567595_8, 505374395_8, &
       507181167_8, 517646580_8, 522845984_8, 525489292_8, &
       527296092_8, 535328763_8, 545493401_8, 551105100_8, 558067631_8, 564682673_8, &
       566489445_8, 568296245_8, 570103045_8, 571909845_8, &
       573716645_8, 575523445_8, 577330217_8, 587207321_8, 592583068_8, 596359990_8, &
       598166790_8, 606406969_8, 617728930_8, 623453884_8, &
       630811823_8, 637722772_8, 639529544_8, 641336344_8, 643143144_8, 644949944_8, &
       646756744_8, 648563544_8, 650370316_8, 660243874_8, &
       665782341_8, 668893391_8, 670700191_8, 678999403_8, 692158895_8, 697902691_8, &
       706018267_8, 713697696_8, 715504468_8, 717311268_8, &
       719118068_8, 720924868_8, 722731668_8, 724538468_8, 726345240_8, 736003584_8, &
       741491761_8, 745446508_8, 747253308_8, 754605322_8, &
       768690322_8, 774342531_8, 782404130_8, 790158517_8, 791965289_8, 793772089_8, &
       795578889_8, 797385689_8, 799192526_8, 800999326_8, &
       802806098_8, 813778601_8, 819270213_8, 821200805_8, 823007870_8, 828611751_8, &
       842007876_8, 847558692_8, 855818678_8, 863713621_8, &
       865520393_8, 867327193_8, 869199887_8, 871006687_8, 872885216_8, 874759560_8, &
       876566332_8, 887827025_8, 893234524_8, 895429188_8, &
       897242426_8, 903101132_8, 913175074_8, 918574960_8, 926605176_8, 934364056_8, &
       936170828_8, 937977628_8, 939816319_8, 941623119_8, &
       943455166_8, 945262345_8, 947069117_8, 956539236_8, 962177555_8, 965440305_8, &
       967315637_8, 973843552_8, 985559340_8, 991280475_8, &
       1000260351_8, 1009017827_8, 1010824599_8, 1012631399_8, 1014596572_8, 1016403372_8, &
       1018363592_8, 1020173441_8, 1021980213_8, 1031670555_8, &
       1037269263_8, 1040837093_8, 1043996969_8, 1051437343_8, 1062293962_8, 1068054150_8, &
       1077080825_8, 1085824114_8, 1087630886_8, 1089437686_8, &
       1091632072_8, 1093438872_8, 1095608817_8, 1097425447_8, 1099232219_8, 1109165718_8, &
       1114775704_8, 1118828103_8, 1127590579_8, 1136236814_8, &
       1144401667_8, 1150240654_8, 1159272325_8, 1168036210_8, 1169842982_8, 1171649782_8, &
       1174120612_8, 1175927412_8, 1178327480_8, 1180142059_8, &
       1181948831_8, 1191453928_8, 1197002262_8, 1201495517_8, 1211216292_8, 1217955715_8, &
       1226630809_8, 1232592261_8, 1241781787_8, 1247721790_8, &
       1249528562_8, 1251335362_8, 1254250483_8, 1256057394_8, 1258730705_8, 1260548537_8, &
       1262355309_8, 1271911139_8, 1277527887_8, 1282467250_8, &
       1296500907_8, 1304389633_8, 1313594204_8, 1319711223_8, 1329269981_8, 1335399673_8, &
       1337209617_8, 1339016389_8, 1340823189_8, 1344298910_8, &
       1346106764_8, 1349244152_8, 1351064417_8, 1352871189_8, 1362453927_8, 1368092865_8, &
       1373495944_8, 1389049914_8, 1398211666_8, 1407854034_8, &
       1414094480_8, 1423895659_8, 1430136369_8, 1431943141_8, 1433750598_8, 1437435460_8, &
       1439245621_8, 1442903894_8, 1444727127_8, 1446533899_8, &
       1456117316_8, 1461736427_8, 1467592438_8, 1484192419_8, 1490888200_8, 1500992441_8, &
       1507329866_8, 1517344757_8, 1523654157_8, 1525880720_8, &
       1529365718_8, 1531172490_8, 1532983700_8, 1536913815_8, 1538739158_8, 1542849663_8, &
       1544675501_8, 1546482273_8, 1556067456_8, 1561651504_8, &
       1567575002_8, 1584595114_8, 1591881604_8, 1602297666_8, 1608702225_8, 1618642970_8, &
       1624983602_8, 1626790374_8, 1628608164_8, 1633070737_8, &
       1634920612_8, 1639380363_8, 1641208721_8, 1643015493_8, 1652586730_8, 1658125850_8, &
       1664074201_8, 1681193007_8, 1688945453_8, 1699565835_8, &
       1705991351_8, 1715885564_8, 1722223834_8, 1724552435_8, 1726359207_8, 1728184164_8, &
       1732602687_8, 1734468695_8, 1739169811_8, 1741000601_8, &
       1742807373_8, 1752379144_8, 1757871168_8, 1763826728_8, 1780837257_8, 1789041009_8, &
       1799774719_8, 1806193077_8, 1815989272_8, 1822288783_8, &
       1824095555_8, 1825928155_8, 1830210031_8, 1832077708_8, 1836918030_8, 1838751400_8, &
       1840558172_8, 1850167467_8, 1855569067_8, 1861451105_8, &
       1876595690_8, 1885110695_8, 1895927171_8, 1902325015_8, 1912013838_8, 1918272047_8, &
       1920078819_8, 1921923261_8, 1925957631_8, 1927845861_8, &
       1932710181_8, 1934546228_8, 1936353000_8, 1945969565_8, 1951454983_8, 1957285982_8, &
       1972280033_8, 1981096580_8, 1991992920_8, 1998371058_8, &
       2008018333_8, 2014254181_8, 2016060953_8, 2017927542_8, 2022006835_8, 2023917386_8, &
       2028717243_8, 2030555879_8, 2032362651_8, 2041946305_8, &
       2047490029_8, 2053319040_8, 2068293784_8, 2077559731_8, 2088558356_8, 2094924735_8, &
       2104635615_8, 2114215568_8, 2116028414_8, 2117835186_8, &
       2119743433_8, 2123583500_8, 2125509518_8, 2130199220_8, 2132041460_8, 2133848232_8, &
       2143838088_8, 2149439845_8, 2155300928_8, 2170383489_8, &
       2180053911_8, 2191129897_8, 2197484390_8, 2207284167_8, 2216916377_8, 2218723149_8, &
       2220670766_8, 2224486664_8, 2226418221_8, 2230977116_8, &
       2232822567_8, 2234629339_8, 2244656492_8, 2250253051_8, 2256080669_8, 2270997863_8, &
       2280853785_8, 2291901199_8, 2298188353_8, 2307840648_8, &
       2317306653_8, 2319113425_8, 2321129753_8, 2325008550_8, 2326964756_8, 2331428147_8, &
       2333276729_8, 2335083501_8, 2345172551_8, 2350703006_8, &
       2356501740_8, 2371322518_8, 2381383238_8, 2392418937_8, 2398658027_8, 2408227384_8, &
       2417595237_8, 2419402009_8, 2421517733_8, 2425150718_8, &
       2427117204_8, 2431475559_8, 2433327804_8, 2435134576_8, 2445215668_8, 2450865483_8, &
       2456688311_8, 2471670771_8, 2482148645_8, 2493240939_8, &
       2499465549_8, 2509096995_8, 2518416762_8, 2520228855_8, 2525587219_8, 2527393991_8, &
       2529648573_8, 2533078876_8, 2535061604_8, 2539659278_8, &
       2541515383_8, 2543322155_8, 2553397007_8, 2559120033_8, 2565023486_8, 2580080084_8, &
       2591000119_8, 2602184923_8, 2608414611_8, 2618188998_8, &
       2627641301_8, 2629448073_8, 2631830292_8, 2635279573_8, 2637312837_8, 2641771909_8, &
       2643632165_8, 2645438937_8, 2655456301_8, 2661127864_8, &
       2667060572_8, 2682018954_8, 2693166548_8, 2704363178_8, 2710559245_8, 2720300014_8, &
       2729728251_8, 2731535023_8, 2734073716_8, 2737461479_8, &
       2739512697_8, 2743916415_8, 2745781442_8, 2747588214_8, 2757757035_8, 2763512727_8, &
       2769471516_8, 2784305815_8, 2795664291_8, 2806889029_8, &
       2813059587_8, 2822774306_8, 2832169446_8, 2833976218_8, 2836721084_8, 2839963634_8, &
       2842146002_8, 2846480890_8, 2848350670_8, 2850157470_8, &
       2860229934_8, 2866026061_8, 2872040708_8, 2886839289_8, 2898468354_8, 2909783979_8, &
       2915952326_8, 2925750651_8, 2935224520_8, 2937031292_8, &
       2939947664_8, 2943198694_8, 2945532711_8, 2949762408_8, 2951635025_8, 2953441825_8, &
       2963507573_8, 2969356923_8, 2975427653_8, 2990285995_8, &
       2998055593_8, 3009494974_8, 3015626446_8, 3025579499_8, 3035210640_8, 3037017412_8, 3040052556_8, &
       3043101196_8, 3045573697_8, 3049660226_8, 3051531677_8, &
       3053338477_8, 3063415986_8, 3069235019_8, 3075343154_8, 3090198941_8, 3098139265_8, &
       3109680464_8, 3115822302_8, 3125841746_8, 3135552951_8, &
       3137359723_8, 3140485044_8, 3143402665_8, 3145986981_8 /)
  integer*8 :: expected_lgrib8(NUM_MSG) = (/ 13342681_8, 10886183_8, 2729609_8, 1985412_8, 4547624_8, &
       2171412_8, 1850730_8, 3953198_8, 8329533_8, 2542287_8, &
       1806772_8, 5275233_8, 10584711_8, 10340931_8, 13787728_8, &
       15284443_8, 14756150_8, 11121739_8, 10971393_8, 14263070_8, &
       3139144_8, 1806772_8, 10881277_8, 2609148_8, 1989794_8, &
       4552122_8, 2178761_8, 1851503_8, 3902658_8, 8313881_8, &
       2492269_8, 1806772_8, 5341057_8, 10369394_8, 10079683_8, &
       15184345_8, 11164578_8, 10968214_8, 1806772_8, 10736775_8, &
       797201_8, 1806772_8, 1806772_8, 5583115_8, 8508552_8, &
       3864603_8, 191_8, 19703638_8, 8413599_8, 8429435_8, &
       6444682_8, 8075561_8, 1806772_8, 3939901_8, 9834320_8, &
       5256490_8, 2447248_8, 1806800_8, 8099668_8, 12466701_8, &
       5472078_8, 6415176_8, 6128105_8, 1806772_8, 1806800_8, &
       1806800_8, 1806800_8, 1806800_8, 1806800_8, 1806772_8, &
       10293497_8, 5248356_8, 4241252_8, 1806800_8, 8014436_8, &
       14678163_8, 5492514_8, 6865261_8, 6432662_8, 1806772_8, &
       1806800_8, 1806800_8, 1806800_8, 1806800_8, 1806800_8, &
       1806772_8, 10465413_8, 5199404_8, 2643308_8, 1806800_8, &
       8032671_8, 10164638_8, 5611699_8, 6962531_8, 6615042_8, &
       1806772_8, 1806800_8, 1806800_8, 1806800_8, 1806800_8, &
       1806800_8, 1806772_8, 9877104_8, 5375747_8, 3776922_8, &
       1806800_8, 8240179_8, 11321961_8, 5724954_8, 7357939_8, &
       6910949_8, 1806772_8, 1806800_8, 1806800_8, 1806800_8, &
       1806800_8, 1806800_8, 1806772_8, 9873558_8, 5538467_8, &
       3111050_8, 1806800_8, 8299212_8, 13159492_8, 5743796_8, &
       8115576_8, 7679429_8, 1806772_8, 1806800_8, 1806800_8, &
       1806800_8, 1806800_8, 1806800_8, 1806772_8, 9658344_8, &
       5488177_8, 3954747_8, 1806800_8, 7352014_8, 14085000_8, &
       5652209_8, 8061599_8, 7754387_8, 1806772_8, 1806800_8, &
       1806800_8, 1806800_8, 1806837_8, 1806800_8, 1806772_8, &
       10972503_8, 5491612_8, 1930592_8, 1807065_8, 5603881_8, &
       13396125_8, 5550816_8, 8259986_8, 7894943_8, 1806772_8, &
       1806800_8, 1872694_8, 1806800_8, 1878529_8, 1874344_8, &
       1806772_8, 11260693_8, 5407499_8, 2194664_8, 1813238_8, &
       5858706_8, 10073942_8, 5399886_8, 8030216_8, 7758880_8, &
       1806772_8, 1806800_8, 1838691_8, 1806800_8, 1832047_8, &
       1807179_8, 1806772_8, 9470119_8, 5638319_8, 3262750_8, &
       1875332_8, 6527915_8, 11715788_8, 5721135_8, 8979876_8, &
       8757476_8, 1806772_8, 1806800_8, 1965173_8, 1806800_8, &
       1960220_8, 1809849_8, 1806772_8, 9690342_8, 5598708_8, &
       3567830_8, 3159876_8, 7440374_8, 10856619_8, 5760188_8, &
       9026675_8, 8743289_8, 1806772_8, 1806800_8, 2194386_8, &
       1806800_8, 2169945_8, 1816630_8, 1806772_8, 9933499_8, &
       5609986_8, 4052399_8, 8762476_8, 8646235_8, 8164853_8, &
       5838987_8, 9031671_8, 8763885_8, 1806772_8, 1806800_8, &
       2470830_8, 1806800_8, 2400068_8, 1814579_8, 1806772_8, &
       9505097_8, 5548334_8, 4493255_8, 9720775_8, 6739423_8, &
       8675094_8, 5961452_8, 9189526_8, 5940003_8, 1806772_8, &
       1806800_8, 2915121_8, 1806911_8, 2673311_8, 1817832_8, &
       1806772_8, 9555830_8, 5616748_8, 4939363_8, 14033657_8, &
       7888726_8, 9204571_8, 6117019_8, 9558758_8, 6129692_8, &
       1809944_8, 1806772_8, 1806800_8, 3475721_8, 1807854_8, &
       3137388_8, 1820265_8, 1806772_8, 9582738_8, 5638938_8, &
       5403079_8, 15553970_8, 9161752_8, 9642368_8, 6240446_8, &
       9801179_8, 6240710_8, 1806772_8, 1807457_8, 3684862_8, &
       1810161_8, 3658273_8, 1823233_8, 1806772_8, 9583417_8, &
       5619111_8, 5856011_8, 16599981_8, 6695781_8, 10104241_8, &
       6337425_8, 10014891_8, 6309400_8, 2226563_8, 3484998_8, &
       1806772_8, 1811210_8, 3930115_8, 1825343_8, 4110505_8, &
       1825838_8, 1806772_8, 9585183_8, 5584048_8, 5923498_8, &
       17020112_8, 7286490_8, 10416062_8, 6404559_8, 9940745_8, &
       6340632_8, 1806772_8, 1817790_8, 4462573_8, 1849875_8, &
       4459751_8, 1828358_8, 1806772_8, 9571237_8, 5539120_8, &
       5948351_8, 17118806_8, 7752446_8, 10620382_8, 6425516_8, &
       9894213_8, 6338270_8, 2328601_8, 1806772_8, 1824957_8, &
       4418523_8, 1866008_8, 4701116_8, 1830790_8, 1806772_8, &
       9571771_8, 5492024_8, 5955560_8, 17010529_8, 8203752_8, &
       10733710_8, 6418358_8, 9796195_8, 6299511_8, 1806772_8, &
       1832600_8, 4281876_8, 1867677_8, 4840322_8, 1833370_8, &
       1806772_8, 9609295_8, 5401600_8, 5882038_8, 15144585_8, &
       8515005_8, 10816476_8, 6397844_8, 9688823_8, 6258209_8, &
       1806772_8, 1844442_8, 4034370_8, 1888230_8, 4864320_8, &
       1836047_8, 1806772_8, 9616565_8, 5485418_8, 5830999_8, &
       14994051_8, 8816547_8, 10896340_8, 6378138_8, 9647275_8, &
       6235848_8, 1806772_8, 1866589_8, 4079293_8, 1910551_8, &
       4799857_8, 1838636_8, 1806772_8, 9583654_8, 5543724_8, &
       5829011_8, 14974744_8, 9265947_8, 10998625_8, 6366379_8, &
       9710880_8, 9579953_8, 1812846_8, 1806772_8, 1908247_8, &
       3840067_8, 1926018_8, 4689702_8, 1842240_8, 1806772_8, &
       9989856_8, 5601757_8, 5861083_8, 15082561_8, 9670422_8, &
       11075986_8, 6354493_8, 9799777_8, 9632210_8, 1806772_8, &
       1947617_8, 3815898_8, 1931557_8, 4558895_8, 1845451_8, &
       1806772_8, 10027153_8, 5596559_8, 5827618_8, 14917194_8, &
       9855922_8, 11047414_8, 6287154_8, 9652295_8, 9466005_8, &
       1806772_8, 2016328_8, 3878797_8, 1956206_8, 4463391_8, &
       1848582_8, 1806772_8, 10089050_8, 5530455_8, 5798734_8, &
       14820778_8, 10060720_8, 11035699_8, 6239090_8, 9569357_8, &
       9367853_8, 1806772_8, 2115724_8, 3632985_8, 1966486_8, &
       4358355_8, 1852245_8, 1806772_8, 10081092_8, 5649815_8, &
       5822828_8, 14982460_8, 10477874_8, 11092294_8, 6224610_8, &
       9631446_8, 9319767_8, 1812093_8, 5358364_8, 1806772_8, &
       2254582_8, 3430303_8, 1982728_8, 4597674_8, 1856105_8, &
       1806772_8, 10074852_8, 5723026_8, 5903453_8, 15056598_8, &
       10920035_8, 11184804_8, 6229688_8, 9774387_8, 9452303_8, &
       1806772_8, 2382219_8, 3449281_8, 2033264_8, 4459072_8, &
       1860256_8, 1806772_8, 10017364_8, 5671563_8, 5932708_8, &
       14958382_8, 11147594_8, 11196630_8, 6196067_8, 9740769_8, &
       9428237_8, 1806772_8, 2538693_8, 3387763_8, 2051218_8, &
       4403718_8, 1865027_8, 1806772_8, 10168821_8, 5755692_8, &
       5958789_8, 14834299_8, 11358476_8, 11224738_8, 6170558_8, &
       9714719_8, 9395140_8, 1806772_8, 2744866_8, 3242550_8, &
       2182368_8, 4334888_8, 1869780_8, 1806800_8, 10072464_8, &
       5796127_8, 6014647_8, 14798581_8, 11629065_8, 11315625_8, &
       6168347_8, 9798325_8, 9473869_8, 1806772_8, 2916372_8, &
       3251030_8, 2334017_8, 4229697_8, 1872617_8, 1806800_8, &
       10065748_8, 5849350_8, 6070730_8, 14858342_8, 7769598_8, &
       11439381_8, 6131472_8, 9953053_8, 9631141_8, 1806772_8, &
       3035144_8, 3048640_8, 2472501_8, 4086529_8, 1871451_8, &
       1806800_8, 10077509_8, 5819033_8, 6108135_8, 14855787_8, &
       7940324_8, 11541199_8, 6141838_8, 10019444_8, 9711205_8, &
       1806772_8, 3125321_8, 2917621_8, 2584316_8, 3934037_8 /)
  
  print *, 'Testing reading GRIB2 file ', TEST_FILE
  print *, 'trying getgb2()...'

  ! Open the file.
  call baopenr(lugb, TEST_FILE, iret)
  if (iret .ne. 0) stop 2

  ! Learn about the file.
  jids = -9999
  jpdt = -9999
  jgdt = -9999
  call getgb2(lugb, 0, jskp, jdisc, jids, jpdtn, jpdt, jgdtn, jgdt,  &
          unpack, jskp, gfld, iret)
  if (iret .ne. 0) stop 3

  ! Close the file.
  call baclose(lugb, iret)  
  if (iret .ne. 0) stop 200

  ! Free memory.
  call gf_free(gfld)
  call gf_finalize(iret)
  if (iret .ne. 0) stop 5
  
  print *, 'OK!'
  print *, 'trying skgb8()...'
  
  ! Open the file.
  call baopenr(lugb, TEST_FILE, iret)
  if (iret .ne. 0) stop 2

  ! Loop through the file, checking location of each message.
  start8 = 0
  do i = 1, NUM_MSG
     call skgb8(lugb, start8, 10000_8, lskip8, lgrib8)
     if (lskip8 .ne. expected_lskip8(i)) stop 101
     if (lgrib8 .ne. expected_lgrib8(i)) stop 102
     start8 = start8 + lgrib8
  end do

  ! Close the file.
  call baclose(lugb, iret)  
  if (iret .ne. 0) stop 200

  print *, 'OK!'
  print *, 'SUCCESS!'
end program test_fv3
